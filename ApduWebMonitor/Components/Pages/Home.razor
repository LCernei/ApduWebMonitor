@page "/"
@using ApduWebMonitor.External
@using ApduWebMonitor.Services
@using System.Collections.ObjectModel
@rendermode InteractiveServer
@inject ApduStore Store
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
@inject UsbReader Reader

<PageTitle>APDU Monitor</PageTitle>

<MudDataGrid T="ApduTransaction" Items="@messages"
             Height="75vh"
             Dense="true"
             Hover="true"
             Striped="true"
             Bordered="true"
             FixedHeader="true"
             MultiSelection="true">
    <ToolBarContent>
        <MudText>Total: @messages.Count</MudText>
        <MudSpacer />
        <MudToggleGroup T="bool" @bind-Value="IsReadable" Delimiters="true">
            <MudToggleItem Value="false">HEX</MudToggleItem>
            <MudToggleItem Value="true">UTF-8</MudToggleItem>
        </MudToggleGroup>
        <MudSpacer />
        <MudTextField @bind-Value="ExportFileName" Label="Export file name" Variant="Variant.Text" />
        <MudButton OnClick="Export"
                   StartIcon="@Icons.Material.Outlined.Download"
                   Color="Color.Success">Export
        </MudButton>
        <MudButton OnClick="@Store.Clear"
                   StartIcon="@Icons.Material.Outlined.Delete"
                   Color="Color.Primary">Clear
        </MudButton>
        <MudButton OnClick="@Reader.RestartSmartCardReaders"
                   StartIcon="@Icons.Material.Outlined.Refresh"
                   Color="Color.Error">Reconnect
        </MudButton>
    </ToolBarContent>

    <Columns>
        @* <SelectColumn T="ApduTransaction" Size="Size.Small" /> *@
        <TemplateColumn CellStyle="width:1%;">
            <CellTemplate>
                <MudIcon Icon="@GetStatusIcon(context.Item)" Color="@GetStatusColor(context.Item)" Size="Size.Small" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Data" Sortable="false" CellStyle="white-space: nowrap;">
            <CellTemplate>
                <MudText>@(context.Item.ToCommandString(IsReadable))</MudText>
                <MudText>@(context.Item.ToResponseString(IsReadable))</MudText>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn StickyRight="true" HeaderStyle="width:1%;" CellStyle="width:1%;">
            <HeaderTemplate>
                <MudIconButton OnClick="@CopyRows" Icon="@Icons.Material.Outlined.CopyAll" Size="Size.Small" />
            </HeaderTemplate>
            <CellTemplate>
                <MudIconButton OnClick="@(() => CopyRow(context.Item))" Icon="@Icons.Material.Outlined.ContentCopy"
                               Size="Size.Small" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    private ReadOnlyObservableCollection<ApduTransaction> messages = new([]);

    private bool IsReadable
    {
        get;
        set
        {
            field = value;
            StateHasChanged();
        }
    }

    public string? ExportFileName { get; set; }

    protected override void OnInitialized()
    {
        messages = Store.GetObservable();
    }

    private async Task CopyRow(ApduTransaction? transaction)
    {
        if (transaction is null)
            return;

        var data = transaction.ToString(IsReadable);
        await JsRuntime.InvokeVoidAsync(Constants.Navigator.Clipboard.WriteText, data);
    }

    private async Task CopyRows()
    {
        var data = string.Join(
            Environment.NewLine,
            messages.Select(x => x.ToString(IsReadable)));

        await JsRuntime.InvokeVoidAsync(Constants.Navigator.Clipboard.WriteText, data);
    }

    private static string GetStatusIcon(ApduTransaction _) => Icons.Material.Filled.Circle;

    private static Color GetStatusColor(ApduTransaction item) => (item.ResponseApdu?.SW1, item.ResponseApdu?.SW2) switch
    {
        (0x90, 0x00) => Color.Success,
        _ => Color.Error
    };

    private async Task Export()
    {
        await SaveFile(string.Join(
            Environment.NewLine,
            messages.Select(x => x.ToString(false))), ExportFileName + ".apdu");

        await SaveFile(string.Join(
            Environment.NewLine,
            messages.Select(x => x.ToString(true))), ExportFileName + ".readable");

        Snackbar.Add("Export successful", Severity.Success,
            config =>
            {
                config.VisibleStateDuration = 1000;
                config.BackgroundBlurred = true;
            });
    }

    private const string FileDownloaderScript =
        """
        (function() {{
            var filename = '{0}';
            var bytesBase64 = '{1}';
            var link = document.createElement('a');
            link.download = filename;
            link.href = 'data:application/octet-stream;base64,' + bytesBase64;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }})();
        """;

    private async Task SaveFile(string data, string fileName)
    {
        var base64Data = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(data));

        // TODO: Find a more secure alternative
        await JsRuntime.InvokeVoidAsync("eval", string.Format(FileDownloaderScript, fileName, base64Data));
    }
}
