@page "/"
@using ApduWebMonitor.External
@using ApduWebMonitor.Services
@using PCSC.Iso7816
@rendermode InteractiveServer
@inject ApduStore Store
@inject IJSRuntime JS
@inject UsbReader Reader
@implements IDisposable

<PageTitle>APDU Monitor</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-3">

    <!-- Toolbar at top -->
    <MudPaper Elevation="1" Class="mb-2">
        <MudToolBar>
            <MudText>Total: @messages.Count</MudText>
            <MudSpacer />
            <MudToggleGroup T="bool" @bind-Value="isReadable" Outlined="true" Delimiters="true" Size="Size.Small" Style="width: 20rem">
                <MudToggleItem Value="false">HEX</MudToggleItem>
                <MudToggleItem Value="true">UTF-8</MudToggleItem>
            </MudToggleGroup>
            <MudSpacer />
            <MudButton OnClick="Clear"
                       StartIcon="@Icons.Material.Outlined.Delete"
                       Variant="Variant.Filled"
                       Color="Color.Primary">Clear</MudButton>
            <MudButton OnClick="Reconnect"
                       StartIcon="@Icons.Material.Outlined.Recycling"
                       Variant="Variant.Filled"
                       Color="Color.Error">Reconnect</MudButton>
        </MudToolBar>
    </MudPaper>

    <!-- Table with alternating colors -->
    <MudPaper Elevation="1" Class="mb-2">
        <MudDataGrid T="Apdu" Items="@messages" Height="calc(100vh - 180px)"
                     Dense="true"
                     Hover="true"
                     Striped="true"
                     Bordered="true"
                     FixedHeader="true">
            <Columns>
                <PropertyColumn Property="@(x => isReadable ? x.ToReadable() : x.ToHex())" Title="Data" CellStyle="white-space:nowrap" />
                <TemplateColumn StickyRight="true" HeaderStyle="width:3rem;" CellStyle="width:3rem;">
                    <HeaderTemplate>
                        <MudIconButton OnClick="CopyRows" Variant="Variant.Filled" Icon="@Icons.Material.Outlined.CopyAll" Size="@Size.Small" />
                    </HeaderTemplate>
                    <CellTemplate>
                        <MudIconButton OnClick="@(() => CopyRow(context.Item))" Icon="@Icons.Material.Outlined.ContentCopy" Size="@Size.Small" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>

</MudContainer>

@code {
    private readonly List<Apdu> messages = new();

    private bool _isReadable;
    private bool isReadable
    {
        get => _isReadable;
        set
        {
            _isReadable = value;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        messages.AddRange(Store.GetMessages());

        Store.MessageAdded += OnAppended;
        Store.Cleared += OnCleared;
    }

    private void OnAppended(Apdu item)
    {
        messages.Add(item);
        InvokeAsync(StateHasChanged);
    }

    private void OnCleared()
    {
        messages.Clear();
        InvokeAsync(StateHasChanged);
    }

    private void Clear()
    {
        Store.Clear();
    }

    private Task Reconnect()
    {
        return Reader.RestartSmartCardReaders();
    }

    private async Task CopyRow(Apdu? apdu)
    {
        if (apdu is null)
            return;
        await JS.InvokeVoidAsync(Constants.Navigator.Clipboard.WriteText, apdu.ToHex());
    }

    private async Task CopyRows()
    {
        var data = string.Join(Environment.NewLine, messages.Select(x => x.ToHex()));
        await JS.InvokeVoidAsync(Constants.Navigator.Clipboard.WriteText, data);
    }

    public void Dispose()
    {
        Store.MessageAdded -= OnAppended;
        Store.Cleared -= OnCleared;
    }
}
