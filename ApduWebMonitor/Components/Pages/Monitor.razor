@page "/monitor"
@using ApduWebMonitor.External
@using ApduWebMonitor.Services
@using PCSC.Iso7816
@rendermode InteractiveServer
@inject ApduStore Store
@inject IJSRuntime JS
@inject UsbReader Reader
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="mt-3">

    <!-- Toolbar at top -->
    <MudPaper Elevation="1" Class="mb-2">
        <MudToolBar>
            <MudText Typo="Typo.h6">APDU Monitor</MudText>
            <MudDivider Vertical="true" Class="mx-2" />
            <MudText>Total: @messages.Count</MudText>
            <MudSpacer />
            <MudCheckBox @bind-Value="isPretty" Label="ASCII" />
            <MudSpacer />
            <MudButton OnClick="Clear"
				StartIcon="@Icons.Material.Outlined.Delete"
				Variant="Variant.Filled"
				Color="Color.Primary">
				Clear
			</MudButton>
            <MudButton OnClick="Restart"
				StartIcon="@Icons.Material.Outlined.Recycling"
				Variant="Variant.Filled"
				Color="Color.Error">
				Reconnect
			</MudButton>
        </MudToolBar>
    </MudPaper>

    <!-- Table with alternating colors -->
    <MudPaper Elevation="1" Class="mb-2">
        <MudDataGrid T="Apdu" Items="@messages" Height="calc(100vh - 180px)"
			Dense="true"
			Hover="true"
			Striped="true"
			Bordered="true"
			FixedHeader="true">
            <Columns>
                <PropertyColumn Property="@(x => isPretty ? x.ToReadable() : x.ToHex())" Title="Data" CellStyle="white-space:nowrap" />
                <TemplateColumn StickyRight="true">
                    <CellTemplate>
                        <MudIconButton OnClick="@(() => CopyRow(context.Item))" Icon="@Icons.Material.Outlined.ContentCopy" Size="@Size.Small" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>

</MudContainer>

@code {
    private readonly List<Apdu> messages = new();

    private bool _isPretty;
    private bool isPretty
    {
        get => _isPretty;
        set
        {
            _isPretty = value;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        messages.AddRange(Store.GetMessages());
        Store.MessageAdded += OnAppended;
        Store.Cleared += OnCleared;
    }

    private void OnAppended(Apdu item)
    {
        messages.Add(item);
        InvokeAsync(StateHasChanged);
    }

    private void OnCleared()
    {
        messages.Clear();
        InvokeAsync(StateHasChanged);
    }

    private void Clear()
    {
        Store.Clear();
    }

    private Task Restart()
    {
        Store.Clear();
        return Reader.RestartSmartCardReaders();
    }

    public void Dispose()
    {
        Store.MessageAdded -= OnAppended;
        Store.Cleared -= OnCleared;
    }

    private async Task OnRowClicks(TableRowClickEventArgs<Apdu> args)
    {
        if (args.Item is null)
            return;

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", args.Item.ToHex());
    }

    private async Task CopyRow(Apdu? apdu)
    {
        if (apdu is null)
            return;

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", apdu.ToHex());
    }
}
